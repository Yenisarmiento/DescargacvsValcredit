<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF Plan de Pagos → CSV (descarga)</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f8fafc; margin:24px; }
    .card { max-width: 920px; margin:auto; padding:24px; background:white; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    h1 { margin:0 0 8px; }
    .muted { color:#6b7280; font-size:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin: 10px 0 6px; }
    button { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
    button.primary { background:#0f172a; color:white; }
    button.secondary { background:#e5e7eb; color:#111827; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    pre { background:#020617; color:#e5e7eb; padding:14px; border-radius:12px; max-height:320px; overflow:auto; font-size:13px; }
    .ok { color:#065f46; }
    .warn { color:#92400e; }
  </style>

  <!-- PDF.js por CDN (estable, crea window.pdfjsLib) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
</head>

<body>
  <div class="card">
    <h1>Convertir Plan de Pagos PDF → CSV</h1>
    <p class="muted">
      Selecciona el PDF. Se intentará descargar automáticamente.
      Si Chrome lo bloquea, usa <b>“Descargar ahora”</b>.
    </p>

    <div class="row">
      <input id="pdfFile" type="file" accept="application/pdf" />
      <button id="btnDownloadNow" class="secondary" disabled>Descargar ahora</button>
    </div>

    <p id="status" class="muted"></p>

    <h3>Vista previa (CSV)</h3>
    <pre id="preview">(esperando PDF...)</pre>
  </div>

<script>
  // Worker por CDN
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

  const fileInput = document.getElementById("pdfFile");
  const btnDownloadNow = document.getElementById("btnDownloadNow");
  const statusEl = document.getElementById("status");
  const previewEl = document.getElementById("preview");

  let pendingUrl = null;
  let pendingFilename = "plan_de_pagos.csv";

  function setStatus(msg, cls="muted") {
    statusEl.className = cls;
    statusEl.textContent = msg;
  }

  function moneyToInt(s) {
    if (!s) return 0;
    const digits = String(s).replace(/[^\d]/g, "");
    return digits ? parseInt(digits, 10) : 0;
  }

  function normalizeText(t) {
    return (t || "")
      .replace(/\u00A0/g, " ")
      .replace(/[ \t]+/g, " ")
      .replace(/\n+/g, "\n");
  }

  async function extractTextFromPdf(file) {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

    let text = "";
    for (let p = 1; p <= pdf.numPages; p++) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      text += content.items.map(i => i.str).join(" ") + "\n";
    }
    return normalizeText(text);
  }

  function prorrateoExacto(total, n) {
    const base = Math.floor(total / n);
    const parts = Array(n).fill(base);
    parts[n-1] = total - base * (n - 1);
    return parts;
  }

  function parsePlan(text) {
    // Valor aval total
    const avalMatch = text.match(/Valor\s+aval\s+\$\s*([\d\.,]+)/i);
    const avalTotal = avalMatch ? moneyToInt(avalMatch[1]) : 0;

    const rows = [];

    // Cuota inicial (si aparece)
    const init = text.match(/Cuota\s+inicial\s+\$\s*([\d\.,]+)\s+(Pago\s+inmediato)/i);
    if (init) {
      const v = moneyToInt(init[1]);
      rows.push({
        numero: "Cuota inicial",
        fecha_pago: init[2],
        valor_total: v,
        aval_prorrateado: 0,
        capital: v
      });
    }

    // Cuotas numeradas
    const cuotas = [];
    const re = /(\d+)\s+\$\s*([\d\.,]+)\s+(\d{2}-\d{2}-\d{4})/g;
    let m;
    while ((m = re.exec(text)) !== null) {
      cuotas.push({
        numero: parseInt(m[1], 10),
        fecha_pago: m[3],
        valor_total: moneyToInt(m[2])
      });
    }
    if (!cuotas.length) throw new Error("No se detectaron cuotas en el PDF (¿es escaneado?).");

    cuotas.sort((a,b) => a.numero - b.numero);

    const n = cuotas.length;
    const parts = prorrateoExacto(avalTotal, n);

    cuotas.forEach((c, i) => {
      const aval = parts[i];
      rows.push({
        ...c,
        aval_prorrateado: aval,
        capital: c.valor_total - aval
      });
    });

    return { rows, avalTotal, n };
  }

  function toCsv(rows) {
    const headers = ["numero","fecha_pago","valor_total","aval_prorrateado","capital"];
    const esc = (v) => {
      const s = (v === null || v === undefined) ? "" : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const lines = [headers.join(",")];
    for (const r of rows) lines.push(headers.map(h => esc(r[h])).join(","));
    return lines.join("\n");
  }

  function prepareDownload(csvText, filename) {
    // limpia url previa
    if (pendingUrl) URL.revokeObjectURL(pendingUrl);

    const blob = new Blob([csvText], { type: "text/csv;charset=utf-8" });
    pendingUrl = URL.createObjectURL(blob);
    pendingFilename = filename;

    // intento de descarga automática
    const a = document.createElement("a");
    a.href = pendingUrl;
    a.download = pendingFilename;
    a.style.display = "none";
    document.body.appendChild(a);
    a.click();
    a.remove();

    // habilita botón por si Chrome bloqueó
    btnDownloadNow.disabled = false;
  }

  btnDownloadNow.addEventListener("click", () => {
    if (!pendingUrl) return;
    const a = document.createElement("a");
    a.href = pendingUrl;
    a.download = pendingFilename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  fileInput.addEventListener("change", async () => {
    const file = fileInput.files?.[0];
    if (!file) return;

    btnDownloadNow.disabled = true;
    previewEl.textContent = "(procesando...)";
    setStatus("Procesando PDF…", "muted");

    try {
      const text = await extractTextFromPdf(file);
      const { rows, avalTotal, n } = parsePlan(text);

      const csv = toCsv(rows);
      previewEl.textContent = csv;

      setStatus(`✅ CSV listo | Cuotas: ${n} | Aval total: ${avalTotal}. Si no se descargó, presiona “Descargar ahora”.`, "ok");
      prepareDownload(csv, "plan_de_pagos.csv");

    } catch (e) {
      console.error(e);
      setStatus("❌ Error: " + (e.message || e), "warn");
      previewEl.textContent = "(error)";
    } finally {
      // permite re-subir el mismo archivo
      fileInput.value = "";
    }
  });
</script>
</body>
</html>
