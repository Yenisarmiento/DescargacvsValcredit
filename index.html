<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>PDF → CSV Plan de Pagos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; padding:20px; }
    .box { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:10px; }
    button { padding:10px 14px; margin-right:10px; }
    pre { background:#111; color:#0f0; padding:10px; max-height:300px; overflow:auto; }
  </style>

  <!-- PDF.js CDN (VERSIÓN ESTABLE) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
</head>

<body>
<div class="box">
  <h2>Convertir Plan de Pagos PDF → CSV</h2>

  <input type="file" id="pdfFile" accept="application/pdf">
  <br><br>

  <button onclick="procesar()">Procesar PDF</button>
  <button onclick="descargar()" id="btnDescargar" disabled>Descargar CSV</button>

  <h3>Resultado</h3>
  <pre id="salida">(esperando PDF)</pre>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

let csvFinal = "";

async function procesar() {
  const file = document.getElementById("pdfFile").files[0];
  if (!file) {
    alert("Sube un PDF");
    return;
  }

  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

  let texto = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    texto += content.items.map(i => i.str).join(" ") + "\n";
  }

  // Extraer valor aval
  const avalMatch = texto.match(/Valor\s+aval\s+\$\s*([\d\.,]+)/i);
  const avalTotal = avalMatch ? parseInt(avalMatch[1].replace(/\D/g,'')) : 0;

  // Extraer cuotas
  const cuotas = [];
  const re = /(\d+)\s+\$\s*([\d\.,]+)\s+(\d{2}-\d{2}-\d{4})/g;
  let m;
  while ((m = re.exec(texto)) !== null) {
    cuotas.push({
      numero: parseInt(m[1]),
      valor: parseInt(m[2].replace(/\D/g,'')),
      fecha: m[3]
    });
  }

  if (!cuotas.length) {
    alert("No se detectaron cuotas");
    return;
  }

  const n = cuotas.length;
  const base = Math.floor(avalTotal / n);
  const ultimo = avalTotal - base * (n - 1);

  let csv = "numero,fecha_pago,valor_total,aval_prorrateado,capital\n";

  cuotas.forEach((c, i) => {
    const aval = (i === n - 1) ? ultimo : base;
    const capital = c.valor - aval;
    csv += `${c.numero},${c.fecha},${c.valor},${aval},${capital}\n`;
  });

  csvFinal = csv;
  document.getElementById("salida").textContent = csv;
  document.getElementById("btnDescargar").disabled = false;
}

function descargar() {
  const blob = new Blob([csvFinal], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "plan_de_pagos.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>

