<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>PDF → CSV Plan de Pagos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; padding:20px; }
    .box { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:10px; }
    button { padding:10px 14px; font-weight:600; }
    button:disabled { opacity:.5; }
    pre { background:#111; color:#0f0; padding:10px; max-height:300px; overflow:auto; }
  </style>

  <!-- PDF.js estable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
</head>

<body>
<div class="box">
  <h2>Convertir Plan de Pagos PDF → CSV</h2>

  <input type="file" id="pdfFile" accept="application/pdf">
  <button id="btnDownload" disabled>Descargar CSV</button>

  <p id="status"></p>

  <h3>Vista previa</h3>
  <pre id="preview">(esperando PDF)</pre>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

let csvGenerado = "";

const fileInput = document.getElementById("pdfFile");
const btnDownload = document.getElementById("btnDownload");
const preview = document.getElementById("preview");
const status = document.getElementById("status");

function money(v){ return parseInt(String(v||"").replace(/\D/g,"")) || 0; }

fileInput.addEventListener("change", async () => {
  btnDownload.disabled = true;
  preview.textContent = "Procesando PDF…";
  status.textContent = "";

  const file = fileInput.files[0];
  if (!file) return;

  const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;

  let text = "";
  for (let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const c = await page.getTextContent();
    text += c.items.map(x=>x.str).join(" ") + "\n";
  }

  const avalMatch = text.match(/Valor\s+aval\s+\$\s*([\d\.,]+)/i);
  const avalTotal = avalMatch ? money(avalMatch[1]) : 0;

  const cuotas = [];
  const re = /(\d+)\s+\$\s*([\d\.,]+)\s+(\d{2}-\d{2}-\d{4})/g;
  let m;
  while((m=re.exec(text))!==null){
    cuotas.push({n:m[1], v:money(m[2]), f:m[3]});
  }

  if(!cuotas.length){
    preview.textContent="No se detectaron cuotas.";
    return;
  }

  const base = Math.floor(avalTotal/cuotas.length);
  const ultimo = avalTotal - base*(cuotas.length-1);

  csvGenerado = "numero,fecha,valor_total,aval,capital\n";
  cuotas.forEach((c,i)=>{
    const aval = i===cuotas.length-1 ? ultimo : base;
    csvGenerado += `${c.n},${c.f},${c.v},${aval},${c.v-aval}\n`;
  });

  preview.textContent = csvGenerado;
  btnDownload.disabled = false;
  status.textContent = "CSV listo. Haz clic en Descargar CSV.";
});

btnDownload.addEventListener("click", ()=>{
  const blob = new Blob([csvGenerado],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "plan_de_pagos.csv";
  a.click();
});
</script>
</body>
</html>

